#!/usr/bin/env bash
# Usage:
#   extract <file>            → extract as archive was made (into cwd)
#   extract <file> <dest>     → extract into <dest>, flatten if single root dir

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: extract <file> [dest]" >&2
    exit 1
fi

file="$1"
dest="${2:-}"

if [[ ! -f "$file" ]]; then
    echo "Error: '$file' is not a valid file" >&2
    exit 1
fi

if [[ -z "$dest" ]]; then
    # in‑place extraction, no flattening
    case "$file" in
        *.rar) unrar x -ad "$file" ;;
        *.7z)  7z x "$file" ;;
        *)     bsdtar -xvf "$file" ;;
    esac
else
    mkdir -p "$dest"
    case "$file" in
        *.rar) unrar x -ad "$file" "$dest" ;;
        *.7z)  7z x "$file" -o"$dest" ;;
        *)     bsdtar -xvf "$file" -C "$dest" ;;
    esac

    # flatten if only one subdirectory
    entries=( "$dest"/* )
    if [[ ${#entries[@]} -eq 1 && -d "${entries[0]}" ]]; then
        subdir="${entries[0]}"
        shopt -s dotglob nullglob
        mv "$subdir"/* "$dest"/
        rmdir "$subdir"
        shopt -u dotglob nullglob
    fi
fi
